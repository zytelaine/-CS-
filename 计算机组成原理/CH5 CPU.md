## CH5 CPU

### 5.1CPU的组成

**1.运算部件ALU**

**2.寄存器**

用于处理的寄存器：通用寄存器组、暂存器

用于控制的寄存器：PC IR

用于主存和I/O接口的寄存器：地址寄存器AR、数据寄存器DR

**3.总线**

**4.控制器（时序系统和微操作命令产生的部件）**

### 5.2控制器的组成

#### 1.功能

**控制机器各部件执行指令**：控制器的基本功能

**1.取指：**由控制器根据程序入口取出第一条指令，发出指令地址和控制信号，把指令从内容取到CPU。

**2.分析指令：**指令译码，对当前的指令进行分析，指出要求什么操作，并产生操作控制命令，形成操作数地址

**3.执行指令：**根据析址产生的操作命令和操作数地址，形成相应的**控制信号序列**。通过CPU和输入输出设备的**执行**，**实现**每条指令的**功能**，其中包括处理运算结果和下调地址指令形成。

计算机不断重复上面三种基本操作，直到遇到停机指令或者外来干预

**4.控制程序和数据的输入输出：**向输入输出设备发出相应的命令来完成I/O功能，也是通过执行程序完成

**5.对异常情况和某些请求的处理：中断请求信号**。CPU执行完当前指令后，响应该请求，中止当前程序，去执行中断程序。处理完毕后，再返回原程序继续运行。**DMA**（外设和存储器或存储器和存储器直接进行内存存取，无需CPU参与）请求信号，CPU完成当前的机器周期操作后。暂停工作，让出总线给I/O设备，然后CPU从暂时中止的机器周期开始继续执行。DMA操作不允许改变CPU中任一寄存器状态(除 DMA专用部件外)，否则会影响CPU工作的正确性

#### 2.组成

（图中虚线部分表示不在控制器里）

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622085132189.png" alt="image-20250622085132189" style="zoom:50%;" />

**1.PC：程序计数器，也是指令地址寄存器，存放将要执行的下一条指令的地址。**

- 顺序执行，对PC增值形成下一条指令地址
- 非顺序执行，由**转移指令**形成下一条指令地址对PC进行修改

**2.IR：指令寄存器。存放当前正在执行的指令**

**3.指令译码器或操作码译码器**：对指令的**操作码**进行分析，产生相应的控制信号

**4.脉冲源和启停线路：产生一点频率的脉冲信号作为整个机器的时钟脉冲，是机器周期和工作脉冲的基准信号；启停线控制时序信号的发生或停止**

**5.时序控制信号形成部件：在CLK时钟的作用下，根据当前正在执行的指令的需要，产生相应的时序控制信号，并根据被控制部件的反馈调整时序控制信号。**

#### 3.机器指令的执行过程

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622085945709.png" alt="image-20250622085945709" style="zoom:67%;" />

#### 4.指令周期

CPU**每取出并执行一条指令所需的全部时间被称为指令周期**。

由于指令的功能不同，各种指令的**指令周期可能不同**。一个完整的指令周期包含取值、间址、执行、中断。（**不一定会全部这4个都有**）

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622090457395.png" alt="image-20250622090457395" style="zoom:50%;" />

**取指：取值+析指**（操作码译码）

**间址：计算操作数地址！！！**

**执行：取数+运算**

**中断：**当主机和I/O设备进行信息交换时，**CPU在每条指令执行前结束**，发出中断请求，进入中断周期。**保存程序断点。**

每个**指令周期内的机器周期数可以不等**，每个**机器内的节拍（时钟周期/T周期）数也可以不等。**

**王道p206-p207指令周期的数据流**

#### 5.控制器的控制方式

同步控制方式：计算机的每条指令操作都是在相同的时间内完成

异步控制方式：每条指令根据前一条指令是否已经完成的信号来控制

联合控制方式：对大多数指令采用同步控制方式，少数无法同步控制的，用区别对待的方法在时间上给予延迟

#### 6.控制器的组成方式

1.组合逻辑控制器：用逻辑代数设计的，由各类门电路组成

2.微程序控制器：用微程序设计的方法设计，由微程序和门电路构成

#### 7.数据通路的构成

**总线结构中，可以同时进行的数据传输量取决于总线的数量**

1.单总线数据通路：总线上可以有**多个部件同时接受**数据，但是同一时刻**只能一个部件向总线发送**数据。因此，部件需要进行**输出控制**来防止总线冲突。

2.双总线

3.基于专用通路结构的数据通路

### 5.3组合逻辑控制器

**指令周期是由若干个机器周期构成。机器周期是由若干个时钟周期构成。**

### 5.4微程序控制器

基本思想：将每条机器指令转化为一段微程序，并存入控制寄存器，微操作控制信号由微指令产生。

#### 1.基本概念：

微操作：**一条指令**的功能是通过**一系列基本操作**完成的，这些基本操作称为微操作。

微命令：将**控制部件向执行部件发出的控制命令**称为微命令，是构成控制序列的最小单位。**微命令和微操作一一对应**。微命令是微操作的控制信号，微操作是微命令的执行过程。微命令直接有相容和互斥。

微指令：若干**微命令的集合**。微指令是把同时发出的控制信号的有关信息汇集起来而形成。**一条指令分为若干条微指令**。

微地址：存放微指令的控制存储器的单元地址称为微地址。

控制存储器：**微程序放在控制存储器**里面。主要存放**微指令**和**下一条执行的微指令地址**（简称为下址）。一般计算机系统的指令系统固定，所以实现指令的微程序也固定，控制寄存器可以用**只读ROM**实现。（注意：主存储器在CPU外部，用RAM实现）



<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622121834333.png" alt="image-20250622121834333" style="zoom:50%;" />

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622122019950.png" alt="image-20250622122019950" style="zoom:50%;" />

控制字段：产生控制信号

下址字段：下一条微指令的地址

#### 2.微指令的编码设计

##### 1.直接控制法

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622122437527.png" alt="image-20250622122437527" style="zoom:50%;" />

直接编码无需译码。微指令字段的每位代表一个微命令。用或者不用每个微命令，将对应位设置成0/1即可。n个微操作就有n位控制端。

简单直观，但是微指令字长过长，控制存储器容量大。

##### 2.字段直接编译法

将微指令的微命令字段分成若干小段，把互斥的微命令编在同一字段中。相容的微命令组合在不同字段。在微指令寄存器的输出端添加一个译码器，译码器的输出就是原来的微命令。

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622123206529.png" alt="image-20250622123206529" style="zoom:50%;" />

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250622123223471.png" alt="image-20250622123223471" style="zoom:50%;" />

##### 3.字段间接编译法

一个字段的某些微命令需要另一个字段的某些微命令来解释。

进一步减少了指令的长度，但会削弱微指令的并行控制能力。通常作为直接编译法的辅助手段。

### 5.6CPU内部数据通路结构和指令的执行

数据通路由控制部件控制，控制部件根据每条指令功能的不同生成对数据通路的控制信号，数据通路是实现**CPU内部**的运算器与寄存器和寄存器之间的数据交换。

#### 1.单总线

##### 1.执行一条指令

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250623123659895.png" alt="image-20250623123659895" style="zoom:50%;" />

##### 2.从存储器中“读”一个字



- 条件转移指令的执行依据来自：**标志寄存器**
- n位CPU中，n指的是数据总线位数
- CPU中，PC/状态寄存器/通用寄存器对程序员用户都是可见、不透明的；而IR/MAR/MDR都是透明的。
- PC的值由CPU在指令执行过程中进行修改。具体是在取址周期末修改。
- 指令执行过程(4个周期)≠执行周期
- 转移指令时，先判断是否转移成功再是否修改PC中的内容。
- 程序寄存器的位数取决于存储器的容量。
- CPU中的专用寄存器有：PC/IR/MAR/MDR/PSW状态字寄存器，不能随便用通用寄存器代替。
- 指令译码的对象是对指令的操作码字段进行译码。
- CPU中不包含地址译码器。它在主存里。
- CPU中决定指令执行顺序的是PC



- 计算机/CPU工作的最小周期是：**时钟周期（T周期、节拍周期）**
- 控制器的最小工作周期：**工作脉冲**.
- 一个时钟周期有一个工作脉冲
- **CPU周期**：**机器周期**，包含若干个时钟周期。
- **指令周期**：若干个机器周期组成。
- **存取周期**：存储器进行两次独立的存取操作的最小时间间隔。
- 由于CPU内部操作块，而CPU访存一次的时间长，所以**机器周期**通常由**存取周期**来确定。
- 通常把总线访问一次主存或I/O的时间定位一个机器周期。机器周期是执行指令中每步操作所需要的时间。
- **每个机器周期内部的时钟周期可以不等，机器周期长度可变；指令周期内部的机器周期数也可变**
- DMA传输一个数据占用一个**存取周期**
- **指令总是根据PC从主存中读出**，不受什么地址寄存器和转移指令的直接影响。
- 取值操作是控制器自动执行的，不需要相应的指令。
- CPU响应中断的时间是**一条指令结束**。
- 不同长度的指令取指操作可能不同，二地址、三地址、零地址
- CPU根据**指令周期的不同阶段**来**区分**存储器中取出的是**数据还是指令**。
- 指令字长取决于操作码的长度、操作数地址、操作数地址个数，和机器字长没有必然联系



