# Chapter15 查询处理

### 在数据库索引选择操作中，各符号的含义如下：

1. tT：Transfer time (传输时间)
   - 表示从磁盘传输一个数据块到内存所需的时间。
2. tS：Seek time (寻道时间)
   - 表示磁盘磁头定位到目标数据块所需的机械移动时间。
3. hi：Height of the index (索引高度)
   - 对于B+树索引，表示从根节点到叶子节点的层级数（高度）。例如，hi+1*h**i*+1 表示需要访问的节点总数（包括叶子节点）。
4. b：Number of blocks containing the required records (包含所需记录的块数)
   - 在**A3**中，表示满足条件的记录所在的连续磁盘块数量。
5. br：Number of blocks in relation r*r* (关系 r*r* 的总块数)
   - 表示整个关系（表）所占用的磁盘块数量，用于线性搜索的成本计算。

- **线性搜索（A1）**：若未使用索引，需扫描整个表的 br*b**r* 个块，每次扫描需一次寻道（tS*t**S*）和块传输（tT*t**T*）。
- **主索引（A2/A3）**：若索引字段是候选键（唯一），则直接定位到记录；若非唯一，需访问连续的块（b*b* 个）。
- **辅助索引（A4）**：若索引非候选键，可能需访问多个分散的块（每个记录可能位于不同块，成本较高）。

| 名称   | 成本公式                 | 详细解释                  |                                        |
| :----- | :----------------------- | :------------------------ | -------------------------------------- |
| **A1** | 线性搜索(全表扫描)       | `t_S + b_r * t_T`         | 需要一次初始寻道和读取所有数据块的时间 |
| **A1** | 线性搜索(键值相等)       | `t_S + (b_r/2) * t_T`     | 平均只需扫描一半表就能找到唯一记录     |
| **A2** | 聚簇B+树索引(键值相等)   | `(h_i+1)*(t_T+t_S)`       | 需要遍历索引高度+1次I/O操作            |
| **A3** | 聚簇B+树索引(非键值相等) | `h_i*(t_T+t_S)+t_S+b*t_T` | 索引遍历+读取连续的数据块              |
| **A4** | 辅助B+树索引(键值相等)   | `(h_i+1)*(t_T+t_S)`       | 类似于A2的情况                         |
| **A4** | 辅助B+树索引(非键值相等) | `(h_i+n)*(t_T+t_S)`       | 最坏情况，每个记录可能在不同块         |
| **A5** | 聚簇B+树索引(范围比较)   | `h_i*(t_T+t_S)+t_S+b*t_T` | 与A3相同，读取连续块                   |
| **A6** | 辅助B+树索引(范围比较)   | `(h_i+n)*(t_T+t_S)`       | 与A4相同，可能高成本                   |

<img src="C:\Users\Zhao Yitong\AppData\Roaming\Typora\typora-user-images\image-20250427112737275.png" alt="image-20250427112737275" style="zoom:50%;" />

### 详细说明

### A1: 线性搜索(全表扫描)

- **适用场景**：无可用索引或索引不适用时
- **成本**：`t_S + b_r * t_T`
  - 一次初始寻道(`t_S`)
  - 读取表中所有块(`b_r * t_T`)
- **特点**：简单但效率低，适合小表或需要大部分数据的情况

### A1: 线性搜索(键值相等)

- **适用场景**：在键属性上搜索唯一记录
- **成本**：`t_S + (b_r/2) * t_T` (平均情况)
  - 平均只需扫描一半表就能找到记录
  - 最坏情况仍需全表扫描(`b_r * t_T`)
- **特点**：比全表扫描平均快一倍

### A2: 聚簇B+树索引(键值相等)

- **适用场景**：在聚簇主索引上搜索唯一记录
- **成本**：`(h_i+1)*(t_T+t_S)`
  - `h_i`次I/O遍历索引
  - 1次I/O读取数据块
- **特点**：效率高，适合精确查找

### A3: 聚簇B+树索引(非键值相等)

- **适用场景**：在聚簇索引的非唯一属性上搜索
- **成本**：`h_i*(t_T+t_S)+t_S+b*t_T`
  - `h_i`次I/O遍历索引
  - 1次寻道(`t_S`)定位第一个数据块
  - 读取`b`个连续数据块(`b*t_T`)
- **特点**：数据物理连续，适合范围查询

### A4: 辅助B+树索引(键值相等)

- **适用场景**：在辅助索引上搜索唯一记录
- **成本**：`(h_i+1)*(t_T+t_S)`
  - 与A2相同
- **特点**：效率与主索引相当

### A4: 辅助B+树索引(非键值相等)

- **适用场景**：在辅助索引的非唯一属性上搜索
- **成本**：`(h_i+n)*(t_T+t_S)`
  - `h_i`次I/O遍历索引
  - `n`次I/O读取分散的记录
- **特点**：可能非常昂贵，因为每条记录可能在不同块

### A5: 聚簇B+树索引(范围比较)

- **适用场景**：在聚簇索引上进行范围查询
- **成本**：与A3相同
- **特点**：数据物理连续，适合范围查询

### A6: 辅助B+树索引(范围比较)

- **适用场景**：在辅助索引上进行范围查询
- **成本**：与A4相同
- **特点**：可能非常昂贵，因为结果记录可能分散



#### 为什么聚簇B+树索引要hi+1次ts?

### 1. **`h_i`次I/O：遍历索引的层级**

- B+树索引由多层节点组成（根节点、中间节点、叶子节点），**`h_i`表示索引的高度**（即从根节点到叶子节点的层级数）。
- **每次访问一个索引节点都需要一次I/O**（包括寻道`t_S`和传输`t_T`）：
  - 从根节点开始，逐层向下查找，直到叶子节点。
  - 例如，若索引高度`h_i = 2`（根→中间→叶子），则需要**2次I/O**访问索引节点。

------

### 2. **`+1`次I/O：访问数据块**

- 聚簇索引的**叶子节点直接存储数据记录**（或指向数据块的指针，但数据物理有序存放）。
- 找到叶子节点后，还需要**1次I/O**读取包含目标记录的**数据块**：
  - 如果是唯一键查询（A2），只需读取1个数据块。
  - 如果是非唯一键查询（A3），则需读取`b`个连续的数据块（但仅需1次寻道`t_S`，因为数据物理连续）。

------

### 3. **为什么聚簇索引的`+1`次I/O需要寻道时间`t_S`？**

- **数据块可能不与叶子节点同处一个磁盘位置**，即使聚簇索引的数据物理有序，索引节点和数据块仍可能分布在磁盘的不同区域。
- 从索引叶子节点跳转到数据块时，磁盘磁头可能需要**重新定位**（即需要一次新的寻道`t_S`）。



#### 所以寻道和传输的区别是？

### **1. 寻道时间（`t_S`）**

- **定义**：磁头移动到目标磁道（Track）所需的机械运动时间。
- **触发场景**：
  - 当需要读取的磁盘块（Block）与当前磁头位置不在同一磁道时。
  - 例如：跳转到索引节点、跨磁道访问数据块。
- **特点**：
  - **机械操作**：依赖磁盘的物理运动（磁臂移动），速度较慢（通常几毫秒）。
  - **随机访问的主要瓶颈**：频繁寻道会显著降低性能（如辅助索引的非连续数据访问）。
- **示例**：
  - 从根节点跳到叶子节点（不同磁道）需要一次寻道。
  - 若数据块分散（如辅助索引），每条记录可能触发一次寻道。

------

### **2. 传输时间（`t_T`）**

- **定义**：从磁盘块读取数据并传输到内存所需的时间。
- **触发场景**：
  - 读取一个完整的磁盘块（即使只需块中的部分数据）。
  - 例如：加载索引节点或数据块到内存。
- **特点**：
  - **电子操作**：无机械运动，速度较快（通常几十微秒）。
  - **与块大小相关**：传输时间由磁盘带宽和块大小决定（如4KB块约需`0.1ms`）。
- **示例**：
  - 读取B+树的一个节点（如中间节点或叶子节点）。
  - 读取包含记录的数据块（无论记录数量）。

### 3.**在索引操作中的实际表现**

#### **聚簇索引（A2/A3）**

- **`h_i\*(t_S + t_T)`**：
  每次访问索引节点需要一次寻道（跳转到节点所在的磁道）和一次传输（读取节点内容）。
- **`+1`次寻道（`t_S`）**：
  从叶子节点跳转到数据块的磁道（即使数据物理连续，索引和数据可能存储在不同区域）。

#### **辅助索引（A4）**

- **`(h_i + n)\*(t_S + t_T)`**：
  每条匹配记录可能位于不同磁道，导致`n`次寻道（最坏情况下每条记录一次寻道）。

#### **线性扫描（A1）**

- **`t_S + b_r\*t_T`**：
  只需一次初始寻道（定位到表起始位置），后续块连续读取（无额外寻道）。

#### 

#### 辅助索引是因为没有按顺序存放，所以最差情况需要额外的n次遍历处理寻道传输？

是的，**辅助索引（Secondary Index）在非顺序存放时，最差情况下确实需要额外的`n`次寻道和传输**，这是它与聚簇索引（Clustering Index）的核心性能差异所在。以下是详细解释：

------

### **1. 辅助索引的物理存储特性**

- **数据无序性**：
  辅助索引的叶子节点仅存储**索引键值 + 指向数据记录的指针（如主键或物理地址）**，而数据记录本身**未按索引键的顺序物理存储**（例如，数据可能是按主键聚簇的，而非按辅助索引键）。
  - **示例**：在`students`表中，主键是`id`（聚簇索引），辅助索引是`name`。即使`name`索引的叶子节点按字母排序，实际数据仍按`id`物理存放，导致同名学生的记录可能分散在不同磁盘块。
- **指针的随机性**：
  通过辅助索引找到的`n`条匹配记录，其对应的数据块可能分布在磁盘的**不同磁道**上，每次访问都需要重新寻道。

------

### **2. 为什么需要`n`次额外的寻道和传输？**

- **访问流程**（以等值查询`name="Alice"`为例）：
  1. **索引遍历**：
     从B+树根节点到叶子节点，共`h_i`次I/O（每次`t_S + t_T`）。
  2. **获取匹配记录指针**：
     在叶子节点中找到所有`name="Alice"`的指针（假设有`n`条）。
  3. **读取数据记录**：
     每条指针指向的数据记录可能位于**不同的磁盘块**，因此需要：
     - **`n`次寻道（`t_S`）**：磁头跳到每个记录所在的磁道。
     - **`n`次传输（`t_T`）**：读取每个块的内容。
- **总成本**：
  `(h_i + n) * (t_S + t_T)`
  - `h_i`次I/O：索引遍历。
  - `n`次I/O：数据记录访问（最坏情况下每条记录位于不同块）。

------

### **3. 对比聚簇索引的优化**

- **聚簇索引（如A3）**：

  - 数据按索引键物理有序存储，因此匹配的记录会集中在**连续的磁盘块**中。
  - 即使有`n`条记录，也只需：
    - 1次寻道（定位到第一个块）。
    - `b`次传输（连续读取`b`个块，`b`通常远小于`n`）。
  - **成本公式**：`h_i*(t_S + t_T) + t_S + b*t_T`（明显低于辅助索引）。

- **关键区别**：

  | **场景**                | 聚簇索引            | 辅助索引              |
  | :---------------------- | :------------------ | :-------------------- |
  | **数据物理分布**        | 有序且连续          | 完全随机（可能）      |
  | **访问`n`条记录的成本** | 1次寻道 + `b`次传输 | `n`次寻道 + `n`次传输 |